<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Borahae Logger v2.1 - ç„¦é»ä¿®å¾©ç‰ˆ</title>
    <style>
        :root { --main-purple: #a020f0; --bg-dark: #121212; --panel-bg: #1e1e1e; }
        body { background: var(--bg-dark); color: #e0e0e0; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 1200px; display: grid; grid-template-columns: 1.2fr 1fr; gap: 20px; }
        .left-panel { position: sticky; top: 20px; height: fit-content; }
        .card { background: var(--panel-bg); padding: 20px; border-radius: 16px; border: 1px solid #333; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        h2 { color: var(--main-purple); margin-top: 0; display: flex; align-items: center; gap: 10px; }
        
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input[type="text"] { background: #2d2d2d; border: 1px solid #444; color: white; padding: 10px; border-radius: 8px; flex: 1; outline: none; }
        
        #player-container { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; overflow: hidden; border: 2px solid #333; position: relative; }
        
        /* ç„¦é»æç¤ºæ¡† (ç•¶ç„¦é»åœ¨ Iframe è£¡æ™‚é¡¯ç¤º) */
        #focus-guard {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border: 4px solid #AB46D2; box-sizing: border-box; pointer-events: none; z-index: 10;
            box-shadow: inset 0 0 20px #AB46D2;
        }

        .timer-display { font-size: 24px; font-family: monospace; color: var(--main-purple); margin: 15px 0; text-align: center; background: #000; padding: 10px; border-radius: 8px; }
        
        .right-panel { background: var(--panel-bg); padding: 20px; border-radius: 16px; height: 90vh; overflow-y: auto; border: 1px solid #333; }
        
        /* Log Item æ¨£å¼ */
        .log-item { display: flex; align-items: center; gap: 8px; padding: 8px; border-bottom: 1px solid #333; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }
        /* è¢«æ’å…¥çš„æ–°é …ç›®æœƒæœ‰é–ƒçˆç‰¹æ•ˆ */
        .log-item.new-entry { animation: flashPurple 1s ease; }
        @keyframes flashPurple { 0% { background: rgba(171, 70, 210, 0.5); } 100% { background: transparent; } }

        .log-item span { font-family: monospace; color: #bbb; width: 60px; font-size: 13px; text-align: right; margin-right: 5px; }
        .log-item input { flex: 1; background: transparent; border: none; border-bottom: 1px solid #444; color: white; padding: 5px; font-size: 14px; }
        .log-item input:focus { border-bottom-color: var(--main-purple); outline: none; }

        .log-item select { background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; padding: 4px; font-size: 12px; cursor: pointer; }
        .log-item[data-type="chant"] input { color: #AB46D2; } 
        .log-item[data-type="sing"] input { color: #00ffff; }  
        .log-item[data-type="scream"] input { color: #ff0055; font-weight: bold; }

        button { background: var(--main-purple); color: white; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button:hover { background: #bc4df5; }
        .del-btn { background: transparent; color: #666; padding: 5px 10px; font-size: 16px; }
        .del-btn:hover { color: #ff4444; background: rgba(255,0,0,0.1); }
        .hotkey-hint { font-size: 12px; color: #777; line-height: 1.6; margin-top: 10px; }
        mark { background: #444; color: #ddd; padding: 2px 5px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <div class="left-panel">
        <div class="card">
            <h2>ğŸ’œ Borahae Logger v2.1</h2>
            <div class="input-group">
                <input type="text" id="yt-url" placeholder="è¼¸å…¥ YouTube å½±ç‰‡ ID" value="MBdVXkSdhwU">
                <button onclick="loadVideo()">è¼‰å…¥å½±ç‰‡</button>
            </div>
            
            <div id="player-container">
                <div id="player"></div>
                <div id="focus-guard"></div> </div>
            
            <div class="timer-display">å½±ç‰‡é€²åº¦ï¼š<span id="current-sec">0.000</span> s</div>
            
            <div style="display: flex; gap: 10px;">
             <button onclick="applyGlobalOffset(-100)" style="background:#444;">âª -100ms</button>
             <button onclick="applyGlobalOffset(100)" style="background:#444;">â© +100ms</button>
             <button onclick="forceFocus()" style="background:#222; border:1px solid #555;">ğŸ¯ é‡ç½®ç„¦é» (æŒ‰æˆ‘ä¿®å¾©)</button>
            </div>
            
            <div class="hotkey-hint">
                ğŸ’¡ <b>æ’å…¥è£œéŒ„æ•™å­¸ï¼š</b><br>
                1. æ‹–å‹•é€²åº¦æ¢åˆ°ä½ æƒ³è£œéŒ„çš„åœ°æ–¹ã€‚<br>
                2. <b>é»æ“Šä¸€ä¸‹é€™è£¡ (æˆ–æŒ‰ "é‡ç½®ç„¦é»") ç¢ºä¿ç©ºç™½éµæœ‰æ•ˆã€‚</b><br>
                3. æŒ‰ä¸‹ç©ºç™½éµæŠ“é»ï¼Œç³»çµ±æœƒè‡ªå‹•å°‡æ–°ç´€éŒ„<b>æ’å…¥</b>åˆ°æ­£ç¢ºä½ç½®ã€‚<br>
                4. <mark>Space</mark>: æŠ“é» / <mark>Esc</mark>: æ’­æ”¾æš«åœ
            </div>
        </div>

        <div class="card">
            <button onclick="exportJSON()" style="width: 100%; padding: 15px;">ğŸš€ ç”Ÿæˆ JSON ä¸¦è¤‡è£½</button>
            <textarea id="json-output" style="width:100%; height:80px; margin-top:10px; background:#000; color:#0f0; font-family:monospace; font-size:11px;" readonly></textarea>
            <button onclick="clearLogs()" style="background:#333; width:100%; margin-top:10px; font-size:11px;">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰ç´€éŒ„</button>
        </div>
    </div>

    <div class="right-panel">
        <h3 style="margin-top:0; color:var(--main-purple); border-bottom: 2px solid var(--main-purple); padding-bottom: 10px;">æ‰‹å·¥å°æ‹æ¸…å–®</h3>
        <div id="log-list"></div>
    </div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    let player;
    let logs = [];
    const reactionDelay = 200; 

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '100%', width: '100%', videoId: 'MBdVXkSdhwU',
            playerVars: { 'autoplay': 0, 'controls': 1 },
            events: { 
                'onReady': loadFromLocal,
                'onStateChange': onPlayerStateChange // ğŸ†• æ–°å¢ç‹€æ…‹ç›£è½
            } 
        });
        setInterval(() => {
            if (player && player.getCurrentTime) {
                document.getElementById('current-sec').innerText = player.getCurrentTime().toFixed(3);
            }
        }, 30);
    }

    // ğŸ†• è‡ªå‹•å¥ªå›ç„¦é»é‚è¼¯
    function onPlayerStateChange(event) {
        // ç•¶å½±ç‰‡é–‹å§‹æ’­æ”¾ (State=1) æˆ– æš«åœ (State=2)
        if (event.data === YT.PlayerState.PLAYING || event.data === YT.PlayerState.PAUSED) {
            // å¼·åˆ¶æŠŠç„¦é»é‚„çµ¦ windowï¼Œé€™æ¨£ç©ºç™½éµæ‰ä¸æœƒè¢« YouTube åƒæ‰
            window.focus();
            document.activeElement.blur(); 
        }
    }

    function forceFocus() {
        window.focus();
        if(document.activeElement) document.activeElement.blur();
    }

    function loadVideo() {
        const vid = document.getElementById('yt-url').value;
        if(vid) player.loadVideoById(vid);
    }

    window.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        if (e.code === 'Space') {
            e.preventDefault();
            const state = player.getPlayerState();
            // é‚è¼¯ï¼šå¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œå°±æŠ“æ™‚é–“ï¼›å¦‚æœæš«åœä¸­ï¼Œå°±é–‹å§‹æ’­æ”¾
            if (state === 1) {
                captureTime(); 
            } else {
                player.playVideo();
            }
        }
        if (e.code === 'Esc' || e.code === 'Escape') {
            const state = player.getPlayerState();
            state === 1 ? player.pauseVideo() : player.playVideo();
        }
    });

    function captureTime() {
        const rawTime = player.getCurrentTime();
        const msTime = Math.round(rawTime * 1000) - reactionDelay;
        const adjustedTime = Math.max(0, msTime); 
        const newId = Date.now();
        
        // é è¨­æŠ“å–ä¸Šä¸€ç­†çš„ typeï¼Œæ–¹ä¾¿é€£çºŒè¼¸å…¥
        let defaultType = "chant";
        if(logs.length > 0) {
             // æ‰¾å‡ºæ™‚é–“æœ€æ¥è¿‘ä½†æ¯”ç¾åœ¨æ—©çš„é‚£ä¸€ç­†
             const prevLog = logs.reduce((prev, curr) => 
                (curr.time < adjustedTime && curr.time > prev.time) ? curr : prev
             , {time: -1, type: "chant"});
             if(prevLog.time !== -1) defaultType = prevLog.type;
        }

        // æ’å…¥æ–°ç´€éŒ„ (å› ç‚ºæˆ‘å€‘æœƒ sortï¼Œæ‰€ä»¥å®ƒæœƒè‡ªå‹•è·‘åˆ°ä¸­é–“)
        logs.push({ id: newId, time: adjustedTime, text: "", type: defaultType });
        logs.sort((a, b) => a.time - b.time); // è‡ªå‹•æ’åºï¼
        
        renderLogs();
        saveToLocal(); 

        setTimeout(() => {
            const row = document.querySelector(`.log-item[data-id="${newId}"]`);
            if (row) {
                row.classList.add('new-entry');
                // ğŸ›‘ å°‡ä¸‹é¢é€™å…©è¡Œåˆªé™¤æˆ–è¨»é‡‹æ‰ï¼š
                // const input = row.querySelector('input');
                // if(input) input.focus(); 
                
                // âœ… åªä¿ç•™æ»¾å‹•è¦–è§’ï¼Œè®“ä½ çœ‹åˆ°æ–°æŠ“çš„é»åœ¨å“ªå³å¯
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }, 50);
    }

    function renderLogs() {
        const list = document.getElementById('log-list');
        list.innerHTML = logs.map((log) => `
            <div class="log-item" data-id="${log.id}" data-type="${log.type}">
                <span>${log.time}ms</span> 
                <select onchange="updateLogType(${log.id}, this.value)">
                    <option value="chant" ${log.type === 'chant' ? 'selected' : ''}>ğŸ’œ Chant</option>
                    <option value="sing" ${log.type === 'sing' ? 'selected' : ''}>ğŸ§Š Sing</option>
                    <option value="scream" ${log.type === 'scream' ? 'selected' : ''}>ğŸ”¥ Scream</option>
                </select>
                <input type="text" value="${log.text}" oninput="updateLogText(${log.id}, this.value)" placeholder="è¼¸å…¥æ‡‰æ´è©...">
                <button class="del-btn" onclick="removeLog(${log.id})">âœ•</button>
            </div>
        `).join('');
    }

    function updateLogText(id, val) {
        const item = logs.find(l => l.id === id);
        if (item) item.text = val;
        saveToLocal(); 
    }

    function updateLogType(id, val) {
        const item = logs.find(l => l.id === id);
        if (item) {
            item.type = val;
            const row = document.querySelector(`.log-item[data-id="${id}"]`);
            if(row) row.setAttribute('data-type', val);
        }
        saveToLocal();
    }

    function removeLog(id) {
        logs = logs.filter(l => l.id !== id);
        renderLogs();
        saveToLocal();
    }

    function saveToLocal() {
        localStorage.setItem('borahae_draft_v2', JSON.stringify(logs));
    }

    function loadFromLocal() {
        const draft = localStorage.getItem('borahae_draft_v2');
        if (draft) {
            logs = JSON.parse(draft);
            renderLogs();
        }
    }

    function applyGlobalOffset(ms) {
        logs = logs.map(log => ({ ...log, time: Math.max(0, log.time + ms) }));
        logs.sort((a, b) => a.time - b.time);
        renderLogs();
        saveToLocal();
    }

    function exportJSON() {
        const exportData = logs.map(({time, text, type}) => ({time, text, type}));
        const jsonStr = JSON.stringify(exportData, null, 2);
        const textarea = document.getElementById('json-output');
        textarea.value = jsonStr;
        textarea.select();
        document.execCommand('copy');
        alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
    }

    function clearLogs() {
        if(confirm("ç¢ºå®šè¦æ¸…ç©ºå—ï¼Ÿ")) {
            logs = [];
            localStorage.removeItem('borahae_draft_v2');
            renderLogs();
            document.getElementById('json-output').value = "";
        }
    }
</script>
</body>
</html>

