<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Borahae Logger - æ‰‹å·¥å°æ‹æœ€çµ‚ç‰ˆ</title>
    <style>
        :root { --main-purple: #a020f0; --bg-dark: #121212; --panel-bg: #1e1e1e; }
        body { background: var(--bg-dark); color: #e0e0e0; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 1200px; display: grid; grid-template-columns: 1.2fr 1fr; gap: 20px; }
        .left-panel { position: sticky; top: 20px; height: fit-content; }
        .card { background: var(--panel-bg); padding: 20px; border-radius: 16px; border: 1px solid #333; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        h2 { color: var(--main-purple); margin-top: 0; display: flex; align-items: center; gap: 10px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input[type="text"] { background: #2d2d2d; border: 1px solid #444; color: white; padding: 10px; border-radius: 8px; flex: 1; outline: none; }
        #player-container { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; overflow: hidden; border: 2px solid #333; }
        .timer-display { font-size: 24px; font-family: monospace; color: var(--main-purple); margin: 15px 0; text-align: center; background: #000; padding: 10px; border-radius: 8px; }
        .right-panel { background: var(--panel-bg); padding: 20px; border-radius: 16px; height: 90vh; overflow-y: auto; border: 1px solid #333; }
        .log-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #333; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }
        .log-item span { font-family: monospace; color: #bbb; width: 65px; font-size: 14px; }
        .log-item input { flex: 1; background: transparent; border: none; border-bottom: 1px solid #444; color: white; padding: 5px; }
        .log-item input:focus { border-bottom-color: var(--main-purple); outline: none; }
        button { background: var(--main-purple); color: white; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button:hover { background: #bc4df5; }
        .hotkey-hint { font-size: 12px; color: #777; line-height: 1.6; margin-top: 10px; }
        mark { background: #444; color: #ddd; padding: 2px 5px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <div class="left-panel">
        <div class="card">
            <h2>ğŸ’œ Borahae Logger v1.2</h2>
            <div class="input-group">
                <input type="text" id="yt-url" placeholder="è¼¸å…¥ YouTube å½±ç‰‡ ID (ä¾‹å¦‚: wWxK5eLFw24)">
                <button onclick="loadVideo()">è¼‰å…¥å½±ç‰‡</button>
            </div>
            <div id="player-container"><div id="player"></div></div>
            <div class="timer-display">å½±ç‰‡é€²åº¦ï¼š<span id="current-sec">0.000</span> s</div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="applyGlobalOffset(-0.1)" style="background:#444;">å…¨éƒ¨æå‰ 0.1s</button>
                <button onclick="applyGlobalOffset(0.1)" style="background:#444;">å…¨éƒ¨å»¶å¾Œ 0.1s</button>
            </div>
            
            <div class="hotkey-hint">
                ğŸ’¡ <b>æ‰‹å·¥å°æ‹ç§˜è¨£ï¼š</b><br>
                1. å»£å‘Šæ’­å®Œå¾ŒæŒ‰ä¸‹æ’­æ”¾ã€‚<br>
                2. è½åˆ°æ‡‰æ´é»æŒ‰ <mark>Space</mark>ï¼šè‡ªå‹•æŠ“é»ã€<b>è‡ªå‹•æ’åº</b>ã€è‡ªå‹• Focusã€‚<br>
                3. æŒ‰ä¸‹ <mark>Esc</mark>ï¼šåˆ‡æ›å½±ç‰‡ æš«åœ/æ’­æ”¾ã€‚<br>
                4. ç³»çµ±æœƒ<b>è‡ªå‹•å„²å­˜</b>é€²åº¦è‡³ç€è¦½å™¨ï¼Œä¸ç”¨æ€•é—œæ‰ç¶²é ã€‚
            </div>
        </div>

        <div class="card">
            <button onclick="exportJSON()" style="width: 100%; padding: 15px;">ğŸš€ ç”Ÿæˆ JSON ä¸¦è¤‡è£½</button>
            <textarea id="json-output" style="width:100%; height:80px; margin-top:10px; background:#000; color:#0f0; font-family:monospace; font-size:11px;" readonly></textarea>
            <button onclick="clearLogs()" style="background:#333; width:100%; margin-top:10px; font-size:11px;">æ¸…ç©ºæ‰€æœ‰ç´€éŒ„ (æ…ç”¨)</button>
        </div>
    </div>

    <div class="right-panel">
        <h3 style="margin-top:0; color:var(--main-purple); border-bottom: 2px solid var(--main-purple); padding-bottom: 10px;">æ‰‹å·¥å°æ‹æ¸…å–®</h3>
        <div id="log-list"></div>
    </div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    let player;
    let logs = [];
    const reactionDelay = 0.2; // ç¤¾é•·è¨­å®šçš„åæ‡‰è£œå„Ÿ

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '100%', width: '100%', videoId: 'wWxK5eLFw24',
            playerVars: { 'autoplay': 0, 'controls': 1 },
            events: { 'onReady': loadFromLocal } // è¼‰å…¥æ™‚è®€å–èˆŠé€²åº¦
        });
        setInterval(() => {
            if (player && player.getCurrentTime) {
                document.getElementById('current-sec').innerText = player.getCurrentTime().toFixed(3);
            }
        }, 30);
    }

    function loadVideo() {
        const vid = document.getElementById('yt-url').value;
        if(vid) player.loadVideoById(vid);
    }

    window.addEventListener('keydown', (e) => {
        if (e.code === 'Space') {
            const state = player.getPlayerState();
            if (state === 1) { e.preventDefault(); captureTime(); }
        }
        if (e.code === 'Escape') {
            const state = player.getPlayerState();
            state === 1 ? player.pauseVideo() : player.playVideo();
        }
    });

    function captureTime() {
        const rawTime = player.getCurrentTime();
        const adjustedTime = Math.max(0, rawTime - reactionDelay).toFixed(3);
        const newId = Date.now();
        
        logs.push({ id: newId, time: parseFloat(adjustedTime), text: "", type: "chant" });
        logs.sort((a, b) => a.time - b.time);
        
        renderLogs();
        saveToLocal(); // æ¯æ¬¡æŒ‰ Space å°±å­˜æª”

        setTimeout(() => {
            const targetInput = document.querySelector(`[data-id="${newId}"] input`);
            if (targetInput) {
                targetInput.focus();
                targetInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }, 50);
    }

    function renderLogs() {
        const list = document.getElementById('log-list');
        list.innerHTML = logs.map((log) => `
            <div class="log-item" data-id="${log.id}">
                <span>${log.time.toFixed(3)}s</span>
                <input type="text" value="${log.text}" oninput="updateLogText(${log.id}, this.value)" placeholder="è¼¸å…¥æ‡‰æ´è©...">
                <button class="btn-del" onclick="removeLog(${log.id})" style="background:none; border:none; color:#555; cursor:pointer;">âœ•</button>
            </div>
        `).join('');
    }

    function updateLogText(id, val) {
        const item = logs.find(l => l.id === id);
        if (item) item.text = val;
        saveToLocal(); // æ‰“å­—ä¹Ÿè‡ªå‹•å­˜æª”
    }

    function removeLog(id) {
        logs = logs.filter(l => l.id !== id);
        renderLogs();
        saveToLocal();
    }

    function saveToLocal() {
        localStorage.setItem('borahae_draft', JSON.stringify(logs));
    }

    function loadFromLocal() {
        const draft = localStorage.getItem('borahae_draft');
        if (draft) {
            logs = JSON.parse(draft);
            renderLogs();
        }
    }

    function applyGlobalOffset(seconds) {
        logs = logs.map(log => ({ ...log, time: Math.max(0, parseFloat((log.time + seconds).toFixed(3))) }));
        logs.sort((a, b) => a.time - b.time);
        renderLogs();
        saveToLocal();
    }

    function exportJSON() {
        const exportData = logs.map(({time, text, type}) => ({time, text, type}));
        document.getElementById('json-output').value = JSON.stringify(exportData, null, 2);
    }

    function clearLogs() {
        if(confirm("ç¢ºå®šè¦æ¸…ç©ºå—ï¼Ÿé€™æœƒåˆªé™¤ç€è¦½å™¨å…§å­˜å„²çš„æ‰€æœ‰ç•¶å‰é€²åº¦ï¼")) {
            logs = [];
            localStorage.removeItem('borahae_draft');
            renderLogs();
            document.getElementById('json-output').value = "";
        }
    }
</script>
</body>

</html>
